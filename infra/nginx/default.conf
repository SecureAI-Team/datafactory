upstream api_upstream {
    server api:8000;
}

upstream open_webui_upstream {
    server open-webui:8080;
}

upstream budibase_upstream {
    server budibase:10000;
}

upstream airflow_upstream {
    server airflow:8080;
}

upstream langfuse_upstream {
    server langfuse:3000;
}

upstream openmetadata_upstream {
    server openmetadata:8585;
}

upstream opensearch_upstream {
    server opensearch:9200;
}

upstream minio_upstream {
    server minio:9001;
}

upstream n8n_upstream {
    server n8n:5678;
}

server {
    listen 80;
    server_name _;
    resolver 127.0.0.11 ipv6=off valid=10s;

    # Increase buffer sizes for large headers
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    large_client_header_buffers 4 16k;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # ============================================
    # Open WebUI (Chat Interface)
    # ============================================
    location /chat/ {
        proxy_pass http://open_webui_upstream/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        auth_basic "Restricted";
        auth_basic_user_file /etc/nginx/conf.d/.htpasswd;
    }

    # Open WebUI static assets (SvelteKit)
    location /_app/ {
        proxy_pass http://open_webui_upstream/_app/;
    }

    location /static/ {
        proxy_pass http://open_webui_upstream/static/;
    }

    location /assets/ {
        proxy_pass http://open_webui_upstream/assets/;
    }

    # Open WebUI API endpoints
    location /ollama/ {
        proxy_pass http://open_webui_upstream/ollama/;
    }

    location /openai/ {
        proxy_pass http://open_webui_upstream/openai/;
    }

    location /audio/ {
        proxy_pass http://open_webui_upstream/audio/;
    }

    location /images/ {
        proxy_pass http://open_webui_upstream/images/;
    }

    # ============================================
    # Open WebUI internal API (must be before /api/)
    # ============================================
    location /api/ {
        proxy_pass http://open_webui_upstream/api/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # FastAPI Backend (use /backend/ prefix)
    # ============================================
    location /backend/ {
        proxy_pass http://api_upstream/;
    }

    location /v1/ {
        proxy_pass http://api_upstream/v1/;
    }

    location /docs {
        proxy_pass http://api_upstream/docs;
    }

    location /redoc {
        proxy_pass http://api_upstream/redoc;
    }

    location /openapi.json {
        proxy_pass http://api_upstream/openapi.json;
    }

    # ============================================
    # Budibase (Contribution Portal)
    # ============================================
    location /portal/ {
        proxy_pass http://budibase_upstream/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Budibase static assets
    location /builder/ {
        proxy_pass http://budibase_upstream/builder/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /app/ {
        proxy_pass http://budibase_upstream/app/;
    }

    # ============================================
    # Apache Airflow
    # ============================================
    location /airflow/ {
        proxy_pass http://airflow_upstream/airflow/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # Langfuse (LLM Observability)
    # ============================================
    location /langfuse/ {
        proxy_pass http://langfuse_upstream/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Langfuse Next.js assets
    location /_next/ {
        proxy_pass http://langfuse_upstream/_next/;
    }

    # ============================================
    # OpenMetadata (Data Governance)
    # ============================================
    location /openmetadata/ {
        proxy_pass http://openmetadata_upstream/;
    }

    # ============================================
    # n8n (Workflow Automation)
    # ============================================
    location /n8n/ {
        proxy_pass http://n8n_upstream/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # MinIO Console
    # ============================================
    location /minio/ {
        proxy_pass http://minio_upstream/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # OpenSearch (direct access for debugging)
    # ============================================
    location /opensearch/ {
        proxy_pass http://opensearch_upstream/;
    }

    # ============================================
    # Data Quality Docs (static)
    # ============================================
    location /dq-docs/ {
        alias /usr/share/nginx/html/dq-docs/;
        index index.html;
    }

    # ============================================
    # Health check endpoint
    # ============================================
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Default location
    location / {
        return 301 /chat/;
    }
}
