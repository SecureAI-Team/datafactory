server {
    listen 80;
    server_name _;
    resolver 127.0.0.11 ipv6=off valid=10s;

    # Increase buffer sizes for large headers
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    large_client_header_buffers 4 16k;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 300s;

    # ============================================
    # FastAPI Backend
    # ============================================
    location /backend/ {
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api/;
    }

    location = /backend/docs {
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api/docs;
    }

    location = /backend/redoc {
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api/redoc;
    }

    location = /backend/openapi.json {
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api/openapi.json;
    }

    # ============================================
    # Health check endpoint
    # ============================================
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # ============================================
    # Open WebUI - Static assets (NO auth)
    # ============================================
    location /_app/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/_app/;
    }

    location /static/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/static/;
    }

    location /assets/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/assets/;
    }

    location /favicon.png {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/favicon.png;
    }

    location /manifest.json {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/manifest.json;
    }

    # ============================================
    # Open WebUI - API endpoints (NO auth)
    # ============================================
    location /api/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/api/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /ollama/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/ollama/;
    }

    location /openai/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/openai/;
    }

    location /audio/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/audio/;
    }

    location /images/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/images/;
    }

    location /ws {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/ws;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # 自研用户前端 (NEW)
    # ============================================
    location /app {
        set $upstream_web_ui http://web-ui:80;
        proxy_pass $upstream_web_ui;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 自研前端 API (走 FastAPI 后端)
    location /app/api {
        rewrite ^/app/api(.*) /api$1 break;
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api;
    }

    # 分享链接（公开访问）
    location /share/ {
        set $upstream_web_ui http://web-ui:80;
        proxy_pass $upstream_web_ui/share/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # 自研管理后台 (NEW)
    # ============================================
    location /admin {
        set $upstream_admin_ui http://admin-ui:80;
        proxy_pass $upstream_admin_ui;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 管理后台 API (走 FastAPI 后端)
    location /admin/api {
        rewrite ^/admin/api(.*) /api$1 break;
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api;
    }

    # ============================================
    # Open WebUI - Main entry (WITH auth)
    # ============================================
    location / {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        auth_basic "Restricted";
        auth_basic_user_file /etc/nginx/conf.d/.htpasswd;
    }
}
