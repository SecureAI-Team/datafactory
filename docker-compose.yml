services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports: ["5432:5432"]

  minio:
    image: ${MINIO_IMAGE:-minio/minio:latest}
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      # Webhook 通知配置 - 文件上传自动触发 n8n
      MINIO_NOTIFY_WEBHOOK_ENABLE_N8N: "on"
      MINIO_NOTIFY_WEBHOOK_ENDPOINT_N8N: "http://n8n:5678/webhook/file-uploaded"
      MINIO_NOTIFY_WEBHOOK_QUEUE_LIMIT_N8N: "10000"
    volumes: [ "minio:/data" ]
    ports: ["9000:9000","9001:9001"]

  opensearch:
    image: opensearchproject/opensearch:2.13.0
    environment:
      discovery.type: single-node
      DISABLE_SECURITY_PLUGIN: "true"
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: ${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-admin123}
    ulimits: { memlock: -1, nofile: 65536 }
    ports: ["9200:9200"]

  neo4j:
    image: neo4j:5.15-community
    restart: unless-stopped
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-neo4jpass}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    ports:
      - "7474:7474"   # HTTP
      - "7687:7687"   # Bolt

  tika:
    image: apache/tika:2.9.0.0
    ports: ["9998:9998"]

  unstructured:
    image: quay.io/unstructured-io/unstructured-api:latest
    environment:
      UNSTRUCTURED_API_KEY: dev
    ports: ["8001:8000"]

  api:
    build: ./services/api
    depends_on: [postgres, minio, opensearch, tika, unstructured]
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT
      - POSTGRES_DB
      - MINIO_ROOT_USER
      - MINIO_ROOT_PASSWORD
      - MINIO_URL
      - OPENSEARCH_HOST
      - OPENSEARCH_PORT
      - OPENSEARCH_INDEX
      - LANGFUSE_HOST
      - LANGFUSE_API_KEY
      - LANGFUSE_PUBLIC_KEY
      - JWT_SECRET
      - JWT_ALGO
      - UPSTREAM_LLM_URL
      - UPSTREAM_LLM_API_KEY
      - DEFAULT_MODEL
      - GATEWAY_SCENARIO_DEFAULT
      - N8N_WEBHOOK_URL
    ports: ["8000:8000"]

  pipeline:
    build: ./services/pipeline
    environment:
      - MINIO_URL
      - MINIO_ROOT_USER
      - MINIO_ROOT_PASSWORD
      - OPENSEARCH_HOST
      - OPENSEARCH_PORT
      - UPSTREAM_LLM_URL
      - UPSTREAM_LLM_API_KEY
      - DEFAULT_MODEL
    depends_on: [minio, opensearch, tika, unstructured]

  airflow:
    build: ./services/airflow
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/airflow
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
      AIRFLOW__WEBSERVER__BASE_URL: http://localhost:8080
      AIRFLOW__API__AUTH_BACKENDS: airflow.api.auth.backend.basic_auth
      PYTHONPATH: /opt/pipeline:/opt/airflow/dags
      MINIO_ENDPOINT: minio:9000
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      UPSTREAM_LLM_API_KEY: ${DASHSCOPE_API_KEY}
      DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY}
      UPSTREAM_LLM_URL: ${UPSTREAM_LLM_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-qwen-plus}
    volumes:
      - ./services/airflow/dags:/opt/airflow/dags
      - ./services/pipeline:/opt/pipeline
      - airflow_logs:/opt/airflow/logs
    depends_on: [postgres, minio, opensearch, tika, unstructured]
    ports: ["8080:8080"]
    command:
      - bash
      - -c
      - |
        set -e
        echo "Initializing Airflow database..."
        airflow db init || airflow db migrate
        echo "Creating admin user..."
        airflow users create --role Admin --username admin --password admin123 --firstname Admin --lastname User --email admin@example.com 2>/dev/null || echo "User may already exist"
        echo "Starting Airflow webserver..."
        airflow webserver --port 8080 &
        echo "Starting Airflow scheduler..."
        exec airflow scheduler

  langfuse:
    image: ghcr.io/langfuse/langfuse:2
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/langfuse
      NEXTAUTH_SECRET: ${JWT_SECRET:-devsecret-must-be-at-least-32characters}
      NEXTAUTH_URL: http://localhost:3000
      SALT: ${LANGFUSE_SALT:-adf-langfuse-salt-for-encryption-32chars}
      HOSTNAME: 0.0.0.0
      TELEMETRY_ENABLED: "false"
      NEXT_PUBLIC_SIGN_UP_DISABLED: "false"
    depends_on: [postgres]
    ports: ["3000:3000"]

  openmetadata:
    image: openmetadata/server:1.5.3
    environment:
      DB_DRIVER_CLASS: org.postgresql.Driver
      DB_SCHEME: postgresql
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_USER: ${POSTGRES_USER}
      DB_USER_PASSWORD: ${POSTGRES_PASSWORD}
      OM_DATABASE: openmetadata
      OPENMETADATA_CLUSTER_NAME: openmetadata
      SERVER_HOST_API_URL: http://localhost:8585/api
      OM_URI: http://localhost:8585
      PIPELINE_SERVICE_CLIENT_ENABLED: "false"
    depends_on: [postgres]
    ports: ["8585:8585"]

  budibase:
    image: budibase/budibase:2.22.2
    environment:
      BB_ADMIN_USER_EMAIL: admin@example.com
      BB_ADMIN_USER_PASSWORD: admin
      MAIN_PORT: "10000"
    ports: ["10000:80"]

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    environment:
      OPENAI_API_BASE_URL: http://api:8000/v1
      OPENAI_API_KEY: ${DASHSCOPE_API_KEY:-dummy}
      OLLAMA_BASE_URL: ""
      ENABLE_OLLAMA_API: "false"
      WEBUI_URL: http://localhost
      DEFAULT_MODELS: qwen-plus
    ports: ["3001:8080"]
    depends_on: [api]

  n8n:
    image: n8nio/n8n:1.82.1
    environment:
      N8N_BASIC_AUTH_ACTIVE: "false"
      WEBHOOK_URL: ${N8N_WEBHOOK_URL:-http://localhost:5678/}
      N8N_RUNNERS_ENABLED: "true"
      N8N_SECURE_COOKIE: "false"
    ports: ["5678:5678"]

  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    environment:
      CLICKHOUSE_DB: langfuse
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: changeme
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    ports:
      - "8123:8123"
      - "9009:9009"

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports: ["6379:6379"]

  nginx:
    image: nginx:1.25
    volumes:
      - ./infra/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infra/nginx/.htpasswd:/etc/nginx/conf.d/.htpasswd:ro
      - ./services/dq/uncommitted/data_docs:/usr/share/nginx/html/dq-docs
      - ./services/api/static:/usr/share/nginx/html/static
      - ./infra/nginx/certs:/etc/nginx/certs
    depends_on: [api, open-webui, budibase, airflow, langfuse, openmetadata, n8n]
    ports:
      - "80:80"
      - "443:443"
volumes:
  pgdata:
  minio:
  airflow_logs:
  neo4j_data:
  neo4j_logs:

