server {
    listen 80;
    server_name _;
    resolver 127.0.0.11 ipv6=off valid=10s;

    # Increase buffer sizes for large headers
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    large_client_header_buffers 4 16k;

    # Common proxy settings
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # ============================================
    # Open WebUI (Chat Interface)
    # ============================================
    location /chat/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        auth_basic "Restricted";
        auth_basic_user_file /etc/nginx/conf.d/.htpasswd;
    }

    # Open WebUI static assets (SvelteKit)
    location /_app/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/_app/;
    }

    location /static/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/static/;
    }

    location /assets/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/assets/;
    }

    # Open WebUI API endpoints
    location /api/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/api/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /ollama/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/ollama/;
    }

    location /openai/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/openai/;
    }

    location /audio/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/audio/;
    }

    location /images/ {
        set $upstream_webui http://open-webui:8080;
        proxy_pass $upstream_webui/images/;
    }

    # ============================================
    # FastAPI Backend
    # ============================================
    location /backend/ {
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api/;
    }

    location /v1/ {
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api/v1/;
    }

    location /docs {
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api/docs;
    }

    location /redoc {
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api/redoc;
    }

    location /openapi.json {
        set $upstream_api http://api:8000;
        proxy_pass $upstream_api/openapi.json;
    }

    # ============================================
    # Budibase (Contribution Portal)
    # ============================================
    location /portal/ {
        set $upstream_budibase http://budibase:10000;
        proxy_pass $upstream_budibase/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /builder/ {
        set $upstream_budibase http://budibase:10000;
        proxy_pass $upstream_budibase/builder/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /app/ {
        set $upstream_budibase http://budibase:10000;
        proxy_pass $upstream_budibase/app/;
    }

    # ============================================
    # Apache Airflow
    # ============================================
    location /airflow/ {
        set $upstream_airflow http://airflow:8080;
        proxy_pass $upstream_airflow/airflow/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # Langfuse (LLM Observability)
    # ============================================
    location /langfuse/ {
        set $upstream_langfuse http://langfuse:3000;
        proxy_pass $upstream_langfuse/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /_next/ {
        set $upstream_langfuse http://langfuse:3000;
        proxy_pass $upstream_langfuse/_next/;
    }

    # ============================================
    # OpenMetadata (Data Governance)
    # ============================================
    location /openmetadata/ {
        set $upstream_om http://openmetadata:8585;
        proxy_pass $upstream_om/;
    }

    # ============================================
    # n8n (Workflow Automation)
    # ============================================
    location /n8n/ {
        set $upstream_n8n http://n8n:5678;
        proxy_pass $upstream_n8n/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # MinIO Console
    # ============================================
    location /minio/ {
        set $upstream_minio http://minio:9001;
        proxy_pass $upstream_minio/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # OpenSearch (direct access for debugging)
    # ============================================
    location /opensearch/ {
        set $upstream_os http://opensearch:9200;
        proxy_pass $upstream_os/;
    }

    # ============================================
    # Data Quality Docs (static)
    # ============================================
    location /dq-docs/ {
        alias /usr/share/nginx/html/dq-docs/;
        index index.html;
    }

    # ============================================
    # Health check endpoint
    # ============================================
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Default location
    location / {
        return 301 /chat/;
    }
}
